# code-snips:
- title: "ada_tdc_2020.tanf_2009q1"
  category: create_table
  section: tanf
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.tanf_2009q1;
  \nCREATE TABLE ada_tdc_2020.tanf_2009q1
  \nSELECT distinct 
  \na.snn, a.caseid
  \nFROM in_fssa.person_month a 
  \nINNER JOIN in_fssa.case_month on a.caseid = b.caseid
  \nWHERE
  \na.relat = '01' and
  \na.tanf_end = TRUE and
  \nsubstring(a.month,1,4)  = '2009' and
  \nsubstring(a.month,5,2)  in ('01','02','03') 
  \norder by a.ssn,a.month desc"

- title: "ada_tdc_2020.tanf_2016q4"
  category: create_table
  section: tanf
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.tanf_2016q4;
  \nCREATE TABLE ada_tdc_2020.tanf_2016q4
  \nSELECT distinct on (a.ssn)
  \na.snn, a.caseid, a.tanf_start, a.tanf_end, b.county
  \nFROM in_fssa.person_month a 
  \nINNER JOIN in_fssa.case_month on a.caseid = b.caseid
  \nWHERE
  \na.relat = '01' and
  \na.tanf_end = TRUE and
  \nsubstring(a.month,1,4)  = '2016' and
  \nsubstring(a.month,5,2)  in ('10','11','12') 
  \norder by a.ssn,a.month desc"

- title: "ada_tdc_2020.tanf_sprintf_query_inputs"
  category: create_table
  section: tanf
  notebook: create_tables
  language: r
  code: "month_quarter_df <- data.frame(\"month\" = sprintf(\"%02d\",1:12),\"quarter\" = 
  c(rep(1,3),rep(2,3),rep(3,3),rep(4,3)))
  \nexit_quarter <- 1
  \nexit_year <- 2009
  \nquarter_months <- paste0(sprintf(\"'%s'\", month_quarter_df$quarter == exit_quarter
  , \"month\"]), collapse = \",\")
  \ntable_name <- paste0(\"tanf_\",exit_year,\"q\",exit_quarter)"

- title: "ada_tdc_2020.tanf_sprintf_query"
  category: create_table
  section: tanf
  notebook: create_tables
  language: r
  code: "query <- sprintf(\"
  \nDROP TABLE IF EXISTS ada_tdc_2020.%s;
  \nCREATE TABLE ada_tdc_2020.%s
  \nSELECT distinct distinct on (a.ssn)
  \na.snn, a.caseid, a.tanf_start, a.tanf_end, b.county
  \nFROM in_fssa.person_month a 
  \nINNER JOIN in_fssa.case_month on a.caseid = b.caseid
  \nWHERE
  \na.relat = '01' and
  \na.tanf_end = TRUE and
  \nsubstring(a.month,1,4)  = '%s' and
  \nsubstring(a.month,5,2)  in (%s) 
  \norder by a.ssn,a.month desc\"
  \n,table_name,table_name,exit_year,quarter_months)"

- title: "ada_tdc_2020.tanf_wage_2009q1"
  category: create_table
  section: wages
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.tanf_wage_2009q1;
  CREATE TABLE ada_tdc_2020.wage_2009q1
\nSELECT 
\nssn, year, quarter, uiacct, wages, 
\nformat('%s-%s-1', year, quarter*3-2) as job_yr_q
\nFROM in_dwd.wage_by_employer
\nWHERE 
\n((year IN (2009, 2010)) OR (year = 2011 and quarter = 1)) AND
\nssn IN (select distinct ssn from ada_tdc_2020.tanf_2009q1)"

- title: "ada_tdc_2020.tanf_wage_2016q4"
  category: create_table
  section: wages
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.tanf_wage_2016q4;
\nCREATE TABLE ada_tdc_2020.wage_2016q4
\nSELECT 
\nssn, year, quarter, uiacct, wages, 
\nformat('%s-%s-1', year, quarter*3-2) as job_yr_q
\nFROM in_dwd.wage_by_employer
\nWHERE 
\n((year IN (2017,2018)) OR (year = 2016 and quarter = 4)) AND
\nssn IN (select distinct ssn from ada_tdc_2020.tanf_2016q4)"

- title: "all_empl_wage_2016q4"
  category: create_table
  section: wage-employer
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.all_empl_wage_2016q4;
  \nCREATE TABLE ada_tdc_2020.all_empl_wage_2016q4
  \nSELECT *, format('%s-%s-1', year, quarter*3-2) as job_yr_q
  \nfrom in_dwd.wage_by_employer
  \nWHERE 
  \n((year = 2016 and quarter = 4) or (year = 2017 and quarter in (1,2))"

- title: "all_empl_wage_2009q1"
  category: create_table
  section: wage-employer
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.all_empl_wage_2009q1;
  \nCREATE TABLE ada_tdc_2020.all_empl_wage_2009q1 as
  \nSELECT *
  \nfrom in_dwd.wage_by_employer
  \nWHERE 
  \nyear = 2009 and quarter in (1,2,3)"

- title: "all_empl_char_2009q1"
  category: create_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.all_empl_char_2009q1;
  \nCREATE TABLE ada_tdc_2020.all_empl_wage_2009q1
  \nSELECT fein, cnty, naics_3_digit, year, quarter, job_yr_q
  \ncount(ssn) as tot_employment,
  \nsum(wages) as tot_earnings,
  \nsum(wages)/count(ssn) as avg_earnings,
  \npercentile_disc(0.25) within group (order by wages) as bottom_25_earnings,
  \npercentile_disc(0.75) within group (order by wages) as top_25_earnings
  \nfrom ada_tdc_2020.all_empl_wage_2009q1
  \nwhere quarter = 2 and year = 2009
  \ngroup by fein, cnty,naics_3_digit, year, quarter,job_yr_q;"

- title: "alter_all_empl_char_2009q1"
  category: alter_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "ALTER TABLE ada_tdc_2020.all_empl_char_2009q1
  \nADD COLUMN full_quarter_employment int,
  \nADD COLUMN full_quarter_earnings int,
  \nADD COLUMN full_quarter_avg_earnings int"

- title: "update_all_empl_char_2009q1"
  category: update_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "UPDATE ada_tdc_2020.all_empl_char_2009q1 as a
  \nSET
  \nfull_quarter_employment = b.full_quarter_employment,
  \nfull_quarter_earnings = b.full_quarter_earnings
  \nfull_quarter_avg_earnings = b.full_quarter_avg_earnings
  \nFROM (
  \n\tSELECT
  \n\ta.fein, a.cnty,
  \n\tCOUNT(DISTINCT(a.ssn)) as full_quarter_employment,
  \n\tsum(a.wages) as full_quarter_earnings,
  \n\tsum(a.wages)/COUNT(DISTINCT(a.ssn)) as full_quarter_avg_earnings
  \n\tFROM ada_tdc_2020.all_empl_wage_2009q1 a,
  \n\tada_tdc_2020.all_empl_wage_2009q1 b,
  \n\tada_tdc_2020.all_empl_wage_2009q1 c
  \n\tWHERE
  \n\ta.ssn = b.ssn AND a.ssn = c.ssn AND
  \n\ta.fein = b.fein AND a.fein = c.fein AND
  \n\ta.job_yr_q = (b.job_yr_q - '3 month'::interval)::date 
  \n\tAND a.job_yr_q = (c.job_yr_q + '3 month'::interval)::date
  \n\tgroup by a.fein,a.cnty) as b
  \nWHERE a.fein = b.fein;" 

- title: "create_stable_empl_base_2009q1"
  category: create_table
  section: employer-characteristics-base
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.stable_empl_base_2009q1;
  \nCREATE TABLE ada_tdc_2020.stable_empl_base_2009q1 as
  \nSELECT 
  \na.*
  \nFROM ada_tdc_2020.all_empl_wage_2009q1 a,
  \nada_tdc_2020.all_empl_wage_2009q1 b,
  \nada_tdc_2020.all_empl_wage_2009q1 c
  \nWHERE
  \na.ssn = b.ssn AND a.ssn = c.ssn AND
  \na.fein = b.fein AND a.fein = c.fein AND
  \na.job_yr_q = (b.job_yr_q - '3 month'::interval)::date 
  \nAND a.job_yr_q = (c.job_yr_q + '3 month'::interval)::date"

- title: "update_all_empl_char_2009q1_from_base"
  category: update_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "UPDATE ada_tdc_2020.all_empl_char_2009q1 as a
  \nSET
  \nfull_quarter_employment = b.full_quarter_employment,
  \nfull_quarter_earnings = b.full_quarter_earnings
  \nfull_quarter_avg_earnings = b.full_quarter_avg_earnings
  \nFROM (
  \n\tSELECT
  \n\tfein, cnty,
  \n\tCOUNT(DISTINCT(ssn)) as full_quarter_employment,
  \n\tsum(wages) as full_quarter_earnings,
  \n\tsum(wages)/COUNT(DISTINCT(ssn)) as full_quarter_avg_earnings
  \n\tFROM ada_tdc_2020.stable_empl_base_2009q1
  \n\tgroup by fein,cnty) as b
  \nWHERE a.fein = b.fein;" 

- title: "all_empl_char_2016q4"
  category: create_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.all_empl_char_2016q4;
  \nCREATE TABLE ada_tdc_2020.all_empl_char_2016q4
  \nSELECT fein, cnty, naics_3_digit, year, quarter, job_yr_q
  \ncount(ssn) as tot_employment,
  \nsum(wages) as tot_earnings,
  \nsum(wages)/count(ssn) as avg_earnings,
  \npercentile_disc(0.25) within group (order by wages) as bottom_25_earnings,
  \npercentile_disc(0.75) within group (order by wages) as top_25_earnings
  \nfrom ada_tdc_2020.all_empl_wage_2016q4
  \nwhere quarter = 1 and year = 2017
  \ngroup by fein, cnty,naics_3_digit, year, quarter,job_yr_q;"

- title: "alter_all_empl_char_2016q4"
  category: alter_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "ALTER TABLE ada_tdc_2020.all_empl_char_2016q4
  \nADD COLUMN full_quarter_employment int,
  \nADD COLUMN full_quarter_earnings int,
  \nADD COLUMN full_quarter_avg_earnings int"

- title: "update_all_empl_char_2016q4"
  category: update_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "UPDATE ada_tdc_2020.all_empl_char_2016q4 as a
  \nSET
  \nfull_quarter_employment = b.full_quarter_employment,
  \nfull_quarter_earnings = b.full_quarter_earnings
  \nfull_quarter_avg_earnings = b.full_quarter_avg_earnings
  \nFROM (
  \n\tSELECT
  \n\ta.fein, a.cnty,
  \n\tCOUNT(DISTINCT(a.ssn)) as full_quarter_employment,
  \n\tsum(a.wages) as full_quarter_earnings,
  \n\tsum(a.wages)/COUNT(DISTINCT(a.ssn)) as full_quarter_avg_earnings
  \n\tFROM ada_tdc_2020.all_empl_wage_2016q4 a,
  \n\tada_tdc_2020.all_empl_wage_2016q4 b,
  \n\tada_tdc_2020.all_empl_wage_2016q4 c
  \n\tWHERE
  \n\ta.ssn = b.ssn AND a.ssn = c.ssn AND
  \n\ta.fein = b.fein AND a.fein = c.fein AND
  \n\ta.job_yr_q = (b.job_yr_q - '3 month'::interval)::date 
  \n\tAND a.job_yr_q = (c.job_yr_q + '3 month'::interval)::date
  \n\tgroup by a.fein,a.cnty) as b
  \nWHERE a.fein = b.fein;" 

- title: "create_stable_empl_base_2016q4"
  category: create_table
  section: employer-characteristics-base
  notebook: create_tables
  language: sql
  code: "DROP TABLE IF EXISTS ada_tdc_2020.stable_empl_base_2016q4;
  \nCREATE TABLE ada_tdc_2020.stable_empl_base_2016q4 as
  \nSELECT 
  \na.*
  \nFROM ada_tdc_2020.all_empl_wage_2009q1 a,
  \nada_tdc_2020.all_empl_wage_2009q1 b,
  \nada_tdc_2020.all_empl_wage_2009q1 c
  \nWHERE
  \na.ssn = b.ssn AND a.ssn = c.ssn AND
  \na.fein = b.fein AND a.fein = c.fein AND
  \na.job_yr_q = (b.job_yr_q - '3 month'::interval)::date 
  \nAND a.job_yr_q = (c.job_yr_q + '3 month'::interval)::date"

- title: "update_all_empl_char_2016q4_from_base"
  category: update_table
  section: employer-characteristics
  notebook: create_tables
  language: sql
  code: "UPDATE ada_tdc_2020.all_empl_char_2016q4 as a
  \nSET
  \nfull_quarter_employment = b.full_quarter_employment,
  \nfull_quarter_earnings = b.full_quarter_earnings
  \nfull_quarter_avg_earnings = b.full_quarter_avg_earnings
  \nFROM (
  \n\tSELECT
  \n\tfein, cnty,
  \n\tCOUNT(DISTINCT(ssn)) as full_quarter_employment,
  \n\tsum(wages) as full_quarter_earnings,
  \n\tsum(wages)/COUNT(DISTINCT(ssn)) as full_quarter_avg_earnings
  \n\tFROM ada_tdc_2020.stable_empl_base_2016q4
  \n\tgroup by fein,cnty) as b
  \nWHERE a.fein = b.fein;"  




